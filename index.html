<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>DGKN PIXELBOARD</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
    width: 100%;
    background: #111;
    color: #fff;
    font-family: monospace;
    user-select: none;
  }

  header {
    background: #000;
    color: #ffcc00;
    text-align: center;
    font-size: 22px;
    font-weight: bold;
    padding: 10px 0;
    border-bottom: 2px solid #222;
    letter-spacing: 2px;
  }

  #ui {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 10;
    display: flex;
    gap: 8px;
    align-items: center;
    background: rgba(0,0,0,0.5);
    padding: 6px 10px;
    border-radius: 8px;
  }

  input[type="color"], button {
    cursor: pointer;
    border: none;
    outline: none;
  }

  button {
    background: #333;
    color: #fff;
    padding: 4px 8px;
    border-radius: 5px;
  }

  #resetBtn {
    display: none;
    background: #800;
  }

  /* Login-Fenster */
  #loginBox {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%,-50%);
    background: rgba(0,0,0,0.9);
    padding: 30px;
    border-radius: 12px;
    display: none;
    text-align: center;
    box-shadow: 0 0 15px rgba(255,255,255,0.1);
  }

  #loginBox input {
    margin-bottom: 6px;
    width: 180px;
    padding: 5px;
    border: none;
    border-radius: 4px;
    outline: none;
  }

  #closeLogin {
    position: absolute;
    top: 5px;
    right: 5px;
    background: #444;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    padding: 2px 6px;
    font-weight: bold;
  }

  /* Drehendes D-Logo */
  #logoD {
    font-size: 40px;
    color: #ffcc00;
    margin-bottom: 15px;
    animation: rotateD 3s linear infinite;
  }

  @keyframes rotateD {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  canvas {
    display: block;
    width: 100%;
    height: calc(100% - 50px);
    image-rendering: pixelated;
  }
</style>

<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z3SWKGXDK6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-Z3SWKGXDK6');
</script>
</head>
<body>
<header>DGKN PIXELBOARD (LIVE)</header>

<div id="ui">
  <input type="color" id="color" value="#ff0000">
  <button id="adminToggle">Login</button>
  <button id="resetBtn">Alles löschen</button>
</div>

<div id="loginBox">
  <button id="closeLogin">X</button>
  <div id="logoD">D</div>
  <input type="email" id="email" placeholder="E-Mail"><br>
  <input type="password" id="password" placeholder="Passwort"><br>
  <button id="loginBtn">Anmelden</button>
  <button id="logoutBtn" style="display:none;">Abmelden</button>
</div>

<canvas id="canvas"></canvas>

<!-- ==== Firebase Pixelboard ==== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";

// === Firebase-Konfiguration ===
const firebaseConfig = {
  apiKey: "AIzaSyAOLfz_Fr1r9U8Wf0WbZsI9cpkdgXpsIXY",
  authDomain: "dgkn-pixelboard.firebaseapp.com",
  databaseURL: "https://dgkn-pixelboard-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "dgkn-pixelboard",
  storageBucket: "dgkn-pixelboard.firebasestorage.app",
  messagingSenderId: "182698688707",
  appId: "1:182698688707:web:b11791968146323d9ae276"
};

// Firebase initialisieren
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// === Board Setup ===
const gridSize = 75;
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const colorPicker = document.getElementById("color");
const adminBtn = document.getElementById("adminToggle");
const resetBtn = document.getElementById("resetBtn");
const loginBox = document.getElementById("loginBox");
const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const closeLogin = document.getElementById("closeLogin");
const emailField = document.getElementById("email");
const passField = document.getElementById("password");

let admin = false;
const pixelCanvas = document.createElement("canvas");
pixelCanvas.width = gridSize;
pixelCanvas.height = gridSize;
const pctx = pixelCanvas.getContext("2d");

const boardRef = ref(db, "public/pixels");
const resetRef = ref(db, "admin/reset");
let pixels = Array(gridSize * gridSize).fill("#000000");

// === Echtzeit Pixel-Update ===
onValue(boardRef, snapshot => {
  const data = snapshot.val();
  if (data && Array.isArray(data)) {
    pixels = data;
    applyPixels();
    draw();
  }
});

// Lausche auf Admin-Reset (lädt Board neu)
onValue(resetRef, snapshot => {
  if (!snapshot.exists()) return;
  console.log("Admin-Reset erkannt – Board wird neu geladen");
  onValue(boardRef, snap => {
    const data = snap.val();
    if (data && Array.isArray(data)) {
      pixels = data;
      applyPixels();
      draw();
    }
  }, { onlyOnce: true });
});

function applyPixels() {
  for (let i = 0; i < pixels.length; i++) {
    const x = i % gridSize;
    const y = Math.floor(i / gridSize);
    pctx.fillStyle = pixels[i];
    pctx.fillRect(x, y, 1, 1);
  }
}

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight - 50;
  draw();
}
window.addEventListener("resize", resizeCanvas);
resizeCanvas();

function draw() {
  ctx.imageSmoothingEnabled = false;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(pixelCanvas, 0, 0, canvas.width, canvas.height);

  const cellW = canvas.width / gridSize;
  const cellH = canvas.height / gridSize;
  ctx.strokeStyle = "#222";
  ctx.lineWidth = 1;
  for (let x = 0; x <= gridSize; x++) {
    const xpos = Math.floor(x * cellW) + 0.5;
    ctx.beginPath();
    ctx.moveTo(xpos, 0);
    ctx.lineTo(xpos, canvas.height);
    ctx.stroke();
  }
  for (let y = 0; y <= gridSize; y++) {
    const ypos = Math.floor(y * cellH) + 0.5;
    ctx.beginPath();
    ctx.moveTo(0, ypos);
    ctx.lineTo(canvas.width, ypos);
    ctx.stroke();
  }
}

// === Jeder darf malen ===
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const cx = Math.floor((e.clientX - rect.left) / (canvas.width / gridSize));
  const cy = Math.floor((e.clientY - rect.top) / (canvas.height / gridSize));
  if (cx < 0 || cy < 0 || cx >= gridSize || cy >= gridSize) return;
  const i = cy * gridSize + cx;
  pixels[i] = colorPicker.value;
  set(boardRef, pixels);
});

// === Login-Steuerung ===
adminBtn.addEventListener("click", () => {
  loginBox.style.display = "block";
});
closeLogin.addEventListener("click", () => {
  loginBox.style.display = "none";
});

loginBtn.addEventListener("click", async () => {
  try {
    const userCred = await signInWithEmailAndPassword(auth, emailField.value, passField.value);
    console.log("Eingeloggt:", userCred.user.email);
    loginBox.style.display = "none";
    emailField.value = passField.value = "";
  } catch (err) {
    alert("Login fehlgeschlagen: " + err.message);
  }
});

logoutBtn.addEventListener("click", async () => {
  await signOut(auth);
  console.log("Abgemeldet");
});

onAuthStateChanged(auth, user => {
  if (user) {
    admin = true;
    adminBtn.textContent = "Admin: ON";
    adminBtn.style.background = "#800";
    resetBtn.style.display = "inline-block";
    logoutBtn.style.display = "inline-block";
    loginBtn.style.display = "none";
  } else {
    admin = false;
    adminBtn.textContent = "Login";
    adminBtn.style.background = "#333";
    resetBtn.style.display = "none";
    logoutBtn.style.display = "none";
    loginBtn.style.display = "inline-block";
  }
});

// === Reset (nur Admin darf löschen, stabil) ===
resetBtn.addEventListener("click", async () => {
  if (!admin) return;
  if (confirm("Wirklich alles löschen?")) {
    try {
      const emptyPixels = Array(gridSize * gridSize).fill("#000000");
      await set(boardRef, emptyPixels);
      await set(resetRef, Math.random().toString(36).substring(2));
      console.log("Board wurde vollständig zurückgesetzt.");
    } catch (err) {
      console.error("Fehler beim Reset:", err);
      alert("Fehler beim Löschen – bitte später erneut versuchen.");
    }
  }
});
</script>
</body>
</html>
